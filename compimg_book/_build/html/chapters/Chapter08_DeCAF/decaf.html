
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields &#8212; Awesome Computational Imaging</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Chapter08_DeCAF/decaf';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Notes on Chapter08 DeCAF" href="notes.html" />
    <link rel="prev" title="Chapter07 FPM INR" href="../Chapter07_FPM_INR/README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Awesome Computational Imaging</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Awesome-Computational-Imaging
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter01_SIREN</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter01_SIREN/explore_siren.html">Siren Exploration</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Chapter01_SIREN/README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter01_SIREN/siren_notes.html">SIREN Notes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter02_NeRF</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter02_NeRF/nerf.html">NeRF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter02_NeRF/nerf_notes.html">NeRF Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter02_NeRF/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter03_FourierFeatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter03_FourierFeatures/fourier_features.html">Fourier Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter03_FourierFeatures/fourier_features_merged.html">Fourier Features Let Networks Learn High Frequency Functions in Low Dimensional Domains</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Chapter03_FourierFeatures/fourier_features_notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter03_FourierFeatures/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter04_3D_Gaussian_Splatting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter04_3D_Gaussian_Splatting/3DGS.html">3D Gaussian Splatting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter04_3D_Gaussian_Splatting/3DGS_merged.html">Merged 3DGS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter04_3D_Gaussian_Splatting/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter04_3D_Gaussian_Splatting/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter05_Gaussian_Image</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter05_Gaussian_Image/gaussian_image.html">Gaussian Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter05_Gaussian_Image/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter05_Gaussian_Image/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter06_Pixel2Gaussian</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter06_Pixel2Gaussian/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter06_Pixel2Gaussian/pixel2gaussian.html">Pixel2Gaussian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter06_Pixel2Gaussian/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter07_FPM_INR</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter07_FPM_INR/fpm_inr.html">Fourier Ptychographic Microscopy Image Stack Reconstruction Using Implicit Neural Representations</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Chapter07_FPM_INR/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter07_FPM_INR/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter08_DeCAF</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields</a></li>



<li class="toctree-l1"><a class="reference internal" href="notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter09_Neural_SpaceTime</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter09_Neural_SpaceTime/neural_spacetime.html">ðŸ“˜è®ºæ–‡é¢˜ç›®ï¼š</a></li>















<li class="toctree-l1"><a class="reference internal" href="../Chapter09_Neural_SpaceTime/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter09_Neural_SpaceTime/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter10_DDPM</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DDPM/ddpm_blog_intro.html">Background</a></li>

<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DDPM/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DDPM/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter10_DPS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DPS/DPS.html">1. Background</a></li>




<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DPS/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter10_DPS/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter11_ScoreDiffusion</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter11_ScoreDiffusion/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter11_ScoreDiffusion/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter12_PlugAndPlay</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter12_PlugAndPlay/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter12_PlugAndPlay/Plug-and-Play_Priors_Intro.html">Background</a></li>



<li class="toctree-l1"><a class="reference internal" href="../Chapter12_PlugAndPlay/README.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter13_PnP-DM</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter13_PnP-DM/notes.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter13_PnP-DM/README.html">Overview</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Chapter08_DeCAF/decaf.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">1. Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-core-idea">2. The Core Idea</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-formulation">Mathematical Formulation:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributions-of-the-paper">3. Contributions of the Paper</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">4. References</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-files">Loading files</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">Inference</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="image.png" src="../../_images/image9.png" /></p>
<section id="recovery-of-continuous-3d-refractive-index-maps-from-discrete-intensity-only-measurements-using-neural-fields">
<h1>Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields<a class="headerlink" href="#recovery-of-continuous-3d-refractive-index-maps-from-discrete-intensity-only-measurements-using-neural-fields" title="Link to this heading">#</a></h1>
<p><strong>Authors:</strong> Renhao Liu, Yu Sun, Jiabei Zhu, Lei Tian, Ulugbek S. Kamilov<br />
<strong>Affiliations:</strong> Washington University in St. Louis, Boston University<br />
<strong>Published in:</strong> <em>Nature Machine Intelligence</em>, September 2022<br />
<strong>DOI:</strong> https://doi.org/10.1038/s42256-022-00530-3</p>
<hr class="docutils" />
<section id="background">
<h2>1. Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Imaging biological samples without labeling or staining is crucial in biophotonics and quantitative phase imaging. One core technique, <strong>Intensity Diffraction Tomography (IDT)</strong>, reconstructs the 3D <strong>Refractive Index (RI)</strong> distribution of a sample by capturing 2D intensity images under varied illuminations.</p>
<p>However, IDT suffers from two major limitations:</p>
<ul class="simple">
<li><p><strong>Loss of phase information</strong>: Cameras capture only intensity $I = |E|^2$, not the complex-valued optical field.</p></li>
<li><p><strong>Missing-cone problem</strong>: Due to limited-angle illumination, the 3D Fourier spectrum of the object is incomplete, especially along the optical axis ($z$ direction), resulting in elongated and artefact-laden reconstructions.</p></li>
</ul>
<p>Traditional reconstruction methods, like Tikhonov regularization or deep CNNs trained on synthetic datasets, have struggled to produce artefact-free RI volumes under these limitations.</p>
</section>
<hr class="docutils" />
<section id="the-core-idea">
<h2>2. The Core Idea<a class="headerlink" href="#the-core-idea" title="Link to this heading">#</a></h2>
<p>This paper proposes <strong>DeCAF</strong> â€” a novel <strong>Neural Field-based</strong> method that learns a continuous representation of the 3D complex refractive index from intensity-only measurements <strong>without requiring any ground-truth RI maps</strong>.</p>
<p>The core idea is to represent the RI volume using a <strong>coordinate-based MLP</strong> that maps spatial coordinates $(x, y, z)$ to complex-valued permittivity contrast $\Delta \epsilon = \Delta \epsilon_{\text{re}} + j \Delta \epsilon_{\text{im}}$, from which refractive index is derived.</p>
<section id="mathematical-formulation">
<h3>Mathematical Formulation:<a class="headerlink" href="#mathematical-formulation" title="Link to this heading">#</a></h3>
<p>The forward model in IDT is approximately linear under the first Born approximation:</p>
<p>$$
y_\rho \approx A_\rho \Delta \epsilon
$$</p>
<p>The goal is to reconstruct $\Delta \epsilon$ from intensity-only measurements $y_\rho$. The MLP $M_\phi$ is trained by minimizing:</p>
<p>$$
\phi^* = \arg\min_\phi \left{ \mathcal{L}(F(x), y) + \mathcal{R}(x) \right} \quad \text{such that} \quad x = M_\phi(c)
$$</p>
<p>Where:</p>
<ul class="simple">
<li><p>$c = {(x_i, y_i, z_i)}_{i=1}^n$ are input spatial coordinates</p></li>
<li><p>$F$ is the IDT forward model</p></li>
<li><p>$M_\phi$ is the neural field (MLP)</p></li>
<li><p>$\mathcal{L}$ is a measurement consistency loss</p></li>
<li><p>$\mathcal{R}$ is a regularization term</p></li>
</ul>
<p>The predicted refractive index is computed from the learned permittivity contrast using:</p>
<p>$$
n_{\text{re}} = \sqrt{\frac{1}{2} \left( n_0^2 + \Delta \epsilon_{\text{re}} + \sqrt{(n_0^2 + \Delta \epsilon_{\text{re}})^2 + \Delta \epsilon_{\text{im}}^2} \right)}
$$</p>
<p>$$
n_{\text{im}} = \frac{\Delta \epsilon_{\text{im}}}{2 \cdot n_{\text{re}}}
$$</p>
<p>Here $n_0$ is the background refractive index.</p>
</section>
</section>
<hr class="docutils" />
<section id="contributions-of-the-paper">
<h2>3. Contributions of the Paper<a class="headerlink" href="#contributions-of-the-paper" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Introduced <strong>DeCAF</strong>, a test-time self-supervised method using neural fields for 3D RI reconstruction from intensity-only data.</p></li>
<li><p>Designed a novel <strong>radial encoding</strong> to improve neural field performance in the xâ€“y plane.</p></li>
<li><p>Combined <strong>implicit (MLP)</strong> and <strong>explicit (CNN denoiser)</strong> regularization for enhanced reconstruction.</p></li>
<li><p>Achieved <strong>artefact-free RI maps</strong> that significantly reduce missing-cone distortions and outperform baselines like Tikhonov and SIMBA.</p></li>
<li><p>Demonstrated <strong>continuous spatial representation</strong> and super-resolution sampling capability without retraining.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="references">
<h2>4. References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Liu, R., Sun, Y., Zhu, J., Tian, L., &amp; Kamilov, U. S. (2022). Recovery of continuous 3D refractive index maps from discrete intensity-only measurements using neural fields. <em>Nature Machine Intelligence</em>, 4, 781â€“791. https://doi.org/10.1038/s42256-022-00530-3</p></li>
<li><p>Park, Y., Depeursinge, C., &amp; Popescu, G. (2018). Quantitative phase imaging in biomedicine. <em>Nature Photonics</em>, 12(10), 578â€“589.</p></li>
<li><p>Sitzmann, V., et al. (2020). Implicit neural representations with periodic activation functions. <em>NeurIPS</em>, 7462â€“7473.</p></li>
<li><p>Wu, Z., et al. (2020). SIMBA: Scalable inversion in optical tomography using deep denoising priors. <em>IEEE JSTSP</em>, 14(6), 1163â€“1175.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_FORCE_GPU_ALLOW_GROWTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">absl</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">flags</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">imageio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">model.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">model.provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecafEndToEndProvider</span>

<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">absl</span><span class="w"> </span><span class="kn">import</span> <span class="n">flags</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">is_parsed</span><span class="p">():</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;predict.py&#39;</span><span class="p">,</span>
        <span class="s1">&#39;--flagfile=/home/xqgao/2025/MIT/code/NeRF_optics/DeCAF-master/datasets/Celegans_head/pred_config.txt&#39;</span>
    <span class="p">]</span>

<span class="c1"># input, output dirs.</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;input_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;directory for Hreal &amp; Himag&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;model_save_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;saved_model&quot;</span><span class="p">,</span> <span class="s2">&quot;directory for saving model&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;result_save_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;directory for saving results&quot;</span><span class="p">)</span>

<span class="c1"># Prediction config.</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;minimum depth in micrometer&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_max&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;maximum depth in micrometer&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_train_delta&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;z delta in training data&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_delta&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;depth for each layer in micrometer&quot;</span><span class="p">)</span>

<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_boolean</span><span class="p">(</span>
    <span class="s2">&quot;partial_render&quot;</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;Whether to render a subset of z. z_render_min, z_render_max only&quot;</span>
    <span class="s2">&quot;works if this is True&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_render_min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;minimum depth to render in micrometer&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;z_render_max&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;maximum depth to render in micrometer&quot;</span><span class="p">)</span>

<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span><span class="s2">&quot;row_render_min&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;minimum row to render in pixel&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span><span class="s2">&quot;row_render_max&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;maximum row to render in pixel&quot;</span><span class="p">)</span>

<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span><span class="s2">&quot;col_render_min&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;minimum col to render in pixel&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span><span class="s2">&quot;col_render_max&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;maximum col to render in pixel&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;super_resolution_scale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;super resolution scale&quot;</span><span class="p">)</span>

<span class="c1"># Render config.</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;n0&quot;</span><span class="p">,</span> <span class="mf">1.33</span><span class="p">,</span> <span class="s2">&quot;n0 of the medium.&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;render_max&quot;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s2">&quot;Range above average in rendering.&quot;</span><span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">(</span><span class="s2">&quot;render_min&quot;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s2">&quot;Range below average in rendering.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.2.5 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/traitlets/config/application.py&quot;, line 1075, in launch_instance
    app.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelapp.py&quot;, line 739, in start
    self.io_loop.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tornado/platform/asyncio.py&quot;, line 205, in start
    self.asyncio_loop.run_forever()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 608, in run_forever
    self._run_once()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 1936, in _run_once
    handle._run()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/events.py&quot;, line 84, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 545, in dispatch_queue
    await self.process_one()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 534, in process_one
    await dispatch(*args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 437, in dispatch_shell
    await result
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 362, in execute_request
    await super().execute_request(stream, ident, parent)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 778, in execute_request
    reply_content = await reply_content
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 449, in do_execute
    res = shell.run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/zmqshell.py&quot;, line 549, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3098, in run_cell
    result = self._run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3153, in _run_cell
    result = runner(coro)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 128, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3362, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3607, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3667, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/tmp/ipykernel_3600481/785799368.py&quot;, line 8, in &lt;module&gt;
    import tensorflow as tf
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/__init__.py&quot;, line 38, in &lt;module&gt;
    from tensorflow.python.tools import module_util as _module_util
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/__init__.py&quot;, line 37, in &lt;module&gt;
    from tensorflow.python.eager import context
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/context.py&quot;, line 34, in &lt;module&gt;
    from tensorflow.python.client import pywrap_tf_session
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/client/pywrap_tf_session.py&quot;, line 19, in &lt;module&gt;
    from tensorflow.python.client._pywrap_tf_session import *



---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

AttributeError: _ARRAY_API not found



A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.2.5 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/traitlets/config/application.py&quot;, line 1075, in launch_instance
    app.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelapp.py&quot;, line 739, in start
    self.io_loop.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tornado/platform/asyncio.py&quot;, line 205, in start
    self.asyncio_loop.run_forever()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 608, in run_forever
    self._run_once()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 1936, in _run_once
    handle._run()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/events.py&quot;, line 84, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 545, in dispatch_queue
    await self.process_one()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 534, in process_one
    await dispatch(*args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 437, in dispatch_shell
    await result
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 362, in execute_request
    await super().execute_request(stream, ident, parent)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 778, in execute_request
    reply_content = await reply_content
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 449, in do_execute
    res = shell.run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/zmqshell.py&quot;, line 549, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3098, in run_cell
    result = self._run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3153, in _run_cell
    result = runner(coro)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 128, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3362, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3607, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3667, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/tmp/ipykernel_3600481/785799368.py&quot;, line 8, in &lt;module&gt;
    import tensorflow as tf
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/__init__.py&quot;, line 38, in &lt;module&gt;
    from tensorflow.python.tools import module_util as _module_util
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/__init__.py&quot;, line 37, in &lt;module&gt;
    from tensorflow.python.eager import context
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/context.py&quot;, line 36, in &lt;module&gt;
    from tensorflow.python.eager import execute
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/execute.py&quot;, line 21, in &lt;module&gt;
    from tensorflow.python.framework import dtypes
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/framework/dtypes.py&quot;, line 30, in &lt;module&gt;
    from tensorflow.python.lib.core import _pywrap_float8



---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

AttributeError: _ARRAY_API not found



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core._multiarray_umath failed to import



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core.umath failed to import



A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.2.5 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/traitlets/config/application.py&quot;, line 1075, in launch_instance
    app.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelapp.py&quot;, line 739, in start
    self.io_loop.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tornado/platform/asyncio.py&quot;, line 205, in start
    self.asyncio_loop.run_forever()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 608, in run_forever
    self._run_once()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 1936, in _run_once
    handle._run()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/events.py&quot;, line 84, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 545, in dispatch_queue
    await self.process_one()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 534, in process_one
    await dispatch(*args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 437, in dispatch_shell
    await result
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 362, in execute_request
    await super().execute_request(stream, ident, parent)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 778, in execute_request
    reply_content = await reply_content
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 449, in do_execute
    res = shell.run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/zmqshell.py&quot;, line 549, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3098, in run_cell
    result = self._run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3153, in _run_cell
    result = runner(coro)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 128, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3362, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3607, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3667, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/tmp/ipykernel_3600481/785799368.py&quot;, line 8, in &lt;module&gt;
    import tensorflow as tf
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/__init__.py&quot;, line 38, in &lt;module&gt;
    from tensorflow.python.tools import module_util as _module_util
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/__init__.py&quot;, line 37, in &lt;module&gt;
    from tensorflow.python.eager import context
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/context.py&quot;, line 36, in &lt;module&gt;
    from tensorflow.python.eager import execute
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/execute.py&quot;, line 21, in &lt;module&gt;
    from tensorflow.python.framework import dtypes
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/framework/dtypes.py&quot;, line 30, in &lt;module&gt;
    from tensorflow.python.lib.core import _pywrap_float8



---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

AttributeError: _ARRAY_API not found



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core._multiarray_umath failed to import



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core.umath failed to import



A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.2.5 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/traitlets/config/application.py&quot;, line 1075, in launch_instance
    app.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelapp.py&quot;, line 739, in start
    self.io_loop.start()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tornado/platform/asyncio.py&quot;, line 205, in start
    self.asyncio_loop.run_forever()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 608, in run_forever
    self._run_once()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/base_events.py&quot;, line 1936, in _run_once
    handle._run()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/asyncio/events.py&quot;, line 84, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 545, in dispatch_queue
    await self.process_one()
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 534, in process_one
    await dispatch(*args)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 437, in dispatch_shell
    await result
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 362, in execute_request
    await super().execute_request(stream, ident, parent)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/kernelbase.py&quot;, line 778, in execute_request
    reply_content = await reply_content
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/ipkernel.py&quot;, line 449, in do_execute
    res = shell.run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/ipykernel/zmqshell.py&quot;, line 549, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3098, in run_cell
    result = self._run_cell(
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3153, in _run_cell
    result = runner(coro)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 128, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3362, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3607, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3667, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/tmp/ipykernel_3600481/785799368.py&quot;, line 8, in &lt;module&gt;
    import tensorflow as tf
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/__init__.py&quot;, line 38, in &lt;module&gt;
    from tensorflow.python.tools import module_util as _module_util
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/__init__.py&quot;, line 37, in &lt;module&gt;
    from tensorflow.python.eager import context
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/context.py&quot;, line 36, in &lt;module&gt;
    from tensorflow.python.eager import execute
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/execute.py&quot;, line 21, in &lt;module&gt;
    from tensorflow.python.framework import dtypes
  File &quot;/home/xqgao/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/framework/dtypes.py&quot;, line 35, in &lt;module&gt;
    from tensorflow.tsl.python.lib.core import pywrap_bfloat16



---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

AttributeError: _ARRAY_API not found



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core._multiarray_umath failed to import



---------------------------------------------------------------------------

ImportError                               Traceback (most recent call last)

ImportError: numpy.core.umath failed to import



---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

Cell In[1], line 8
      6 import h5py
      7 import logging
----&gt; 8 import tensorflow as tf
      9 tf.get_logger().setLevel(logging.ERROR)
     10 import warnings


File ~/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/__init__.py:38
     35 import sys as _sys
     36 import typing as _typing
---&gt; 38 from tensorflow.python.tools import module_util as _module_util
     39 from tensorflow.python.util.lazy_loader import LazyLoader as _LazyLoader
     41 # Make sure code inside the TensorFlow codebase can use tf2.enabled() at import.


File ~/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/__init__.py:37
     29 # We aim to keep this file minimal and ideally remove completely.
     30 # If you are adding a new file with @tf_export decorators,
     31 # import it in modules_with_exports.py instead.
     32 
     33 # go/tf-wildcard-import
     34 # pylint: disable=wildcard-import,g-bad-import-order,g-import-not-at-top
     36 from tensorflow.python import pywrap_tensorflow as _pywrap_tensorflow
---&gt; 37 from tensorflow.python.eager import context
     39 # pylint: enable=wildcard-import
     40 
     41 # Bring in subpackages.
     42 from tensorflow.python import data


File ~/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/context.py:36
     34 from tensorflow.python.client import pywrap_tf_session
     35 from tensorflow.python.eager import cancellation
---&gt; 36 from tensorflow.python.eager import execute
     37 from tensorflow.python.eager import executor
     38 from tensorflow.python.eager import monitoring


File ~/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/eager/execute.py:21
     19 from tensorflow.python import pywrap_tfe
     20 from tensorflow.python.eager import core
---&gt; 21 from tensorflow.python.framework import dtypes
     22 from tensorflow.python.framework import tensor_conversion_registry
     23 from tensorflow.python.framework import tensor_shape


File ~/anaconda3/envs/tfk/lib/python3.11/site-packages/tensorflow/python/framework/dtypes.py:38
     35 from tensorflow.tsl.python.lib.core import pywrap_bfloat16
     36 from tensorflow.python.framework import cpp_shape_inference_pb2
---&gt; 38 _np_bfloat16 = pywrap_bfloat16.bfloat16_type()
     39 _np_float8_e4m3fn = _pywrap_float8.TF_float8_e4m3fn_type()
     40 _np_float8_e5m2 = _pywrap_float8.TF_float8_e5m2_type()


TypeError: Unable to convert function return value to a Python type! The signature was
	() -&gt; handle
</pre></div>
</div>
<p>#Permittivity to RI conversion</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">perm2RI</span><span class="p">(</span><span class="n">er</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">n0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: This function converts the recovered object&#39;s permittivity contrast into refractive index values more</span>
<span class="sd">                 commonly found in the literature.</span>
<span class="sd">    :param er:  Scalar, 2D, or 3D matrix containing object&#39;s real permittivity contrast</span>
<span class="sd">    :param ei:  scalar, 2D, or 3D matrix containing object&#39;s imaginary permittivity contrast</span>
<span class="sd">    :param n0:  Scalar value containing value of imaging medium&#39;s refractive index value. in Air n0 = 1, in water n0 = 1.33</span>
<span class="sd">    :return: nr: Scalar, 2D, or 3D matrix of object&#39;s real refractive index value.</span>
<span class="sd">             ni: scalar, 2D, or 3D matrix of object&#39;s imaginary refractive index value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;er max: </span><span class="si">{}</span><span class="s2">, er min:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">er</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">n0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">er</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">er</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ei</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ni</span>
</pre></div>
</div>
</section>
</section>
<section id="loading-files">
<h1>Loading files<a class="headerlink" href="#loading-files" title="Link to this heading">#</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;/home/xqgao/2025/MIT/code/NeRF_optics/DeCAF-master/datasets/Celegans_head/Celegans_head.mat&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1">#data = h5py.File(FLAGS.input_dir, &#39;r&#39;)</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">DecafEndToEndProvider</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="inference">
<h1>Inference<a class="headerlink" href="#inference" title="Link to this heading">#</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">measurement_size</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">measurement_size</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span> <span class="o">&lt;</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span> <span class="o">+</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span> <span class="o">&lt;</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span>
<span class="n">key_zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_train_delta</span><span class="p">)</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span><span class="p">)</span>

<span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">partial_render</span><span class="p">:</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">super_resolution_scale</span>
    <span class="n">adjustment</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">rows_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_min</span> <span class="o">-</span> <span class="n">adjustment</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">adjustment</span><span class="p">,</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_max</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_min</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">super_resolution_scale</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_min</span> <span class="o">-</span> <span class="n">adjustment</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">adjustment</span><span class="p">,</span>
        <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_max</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_min</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">super_resolution_scale</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span> <span class="o">&lt;=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_min</span> <span class="o">&lt;=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_max</span> <span class="o">&lt;=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span>

    <span class="n">key_z_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_min</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_train_delta</span>
    <span class="n">partial_zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_max</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span>
    <span class="p">)</span>
    <span class="n">key_z_max</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">partial_zs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span> <span class="o">-</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_train_delta</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key_z_max</span><span class="p">)</span>
    <span class="n">zs_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">key_z_min</span><span class="p">,</span> <span class="n">key_z_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">partial_zs</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">rows_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">zs_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">key_zs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">zs</span><span class="p">))</span>
<span class="n">r_mesh</span><span class="p">,</span> <span class="n">z_mesh</span><span class="p">,</span> <span class="n">c_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">,</span> <span class="n">zs_idx</span><span class="p">,</span> <span class="n">rows_idx</span><span class="p">)</span>

<span class="n">r_mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_mesh</span> <span class="o">/</span> <span class="n">rows</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">c_mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_mesh</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">z_mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_mesh</span> <span class="o">/</span> <span class="n">key_zs</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">mesh_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_mesh</span><span class="p">,</span> <span class="n">c_mesh</span><span class="p">,</span> <span class="n">z_mesh</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">FLAGS</span><span class="o">.</span><span class="n">view_size</span> <span class="o">=</span> <span class="n">rows_idx</span><span class="o">.</span><span class="n">size</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">result_save_dir</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">recon</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span> <span class="n">mesh_grid</span><span class="p">)</span>
<span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">partial_render</span><span class="p">:</span>
    <span class="n">save_name</span> <span class="o">=</span> <span class="s2">&quot;prediction_result_zmax</span><span class="si">{}</span><span class="s2">_zmin</span><span class="si">{}</span><span class="s2">_zdelta</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_to_</span><span class="si">{}</span><span class="s2">_x</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_min</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">row_render_max</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_min</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">col_render_max</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_min</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_render_max</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">super_resolution_scale</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.mat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">save_name</span> <span class="o">=</span> <span class="s2">&quot;prediction_result_zmax</span><span class="si">{}</span><span class="s2">_zmin</span><span class="si">{}</span><span class="s2">_zdelta</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span>
        <span class="n">FLAGS</span><span class="o">.</span><span class="n">z_delta</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.mat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">save_name</span>
    <span class="p">)</span>
<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inference ended in </span><span class="si">{:4}</span><span class="s2"> seconds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">))</span>
<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5_file</span><span class="p">:</span>
    <span class="n">h5_file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;recon&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">recon</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction saved to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="visualization">
<h1>Visualization<a class="headerlink" href="#visualization" title="Link to this heading">#</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ab</span> <span class="o">=</span> <span class="n">recon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ph</span> <span class="o">=</span> <span class="n">recon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">visual</span> <span class="o">=</span> <span class="s2">&quot;n_re&quot;</span>
<span class="n">n_re</span><span class="p">,</span> <span class="n">n_im</span> <span class="o">=</span> <span class="n">perm2RI</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">n0</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">n_re</span>

<span class="k">if</span> <span class="n">visual</span> <span class="o">==</span> <span class="s1">&#39;n_re&#39;</span><span class="p">:</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">n0</span> <span class="o">+</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">render_max</span><span class="p">;</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">n0</span> <span class="o">+</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">render_min</span><span class="p">;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">render_max</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">render_min</span>
<span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">up</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">up</span> <span class="o">-</span> <span class="n">low</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">)</span>
<span class="n">result</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">result</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">result</span> <span class="o">*=</span> <span class="mi">255</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="n">video_frames</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">image_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_dir</span> <span class="o">+</span> <span class="s1">&#39;img_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">video_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.mp4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span>
<span class="c1"># imageio.mimwrite(f, video_frames, fps=8, quality=7)</span>
<span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">]:</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">mimwrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">video_frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">mimwrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">video_frames</span><span class="p">)</span>
</pre></div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Chapter08_DeCAF"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Chapter07_FPM_INR/README.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chapter07 FPM INR</p>
      </div>
    </a>
    <a class="right-next"
       href="notes.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Notes on Chapter08 DeCAF</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Recovery of Continuous 3D Refractive Index Maps from Discrete Intensity-Only Measurements Using Neural Fields</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">1. Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-core-idea">2. The Core Idea</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-formulation">Mathematical Formulation:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributions-of-the-paper">3. Contributions of the Paper</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">4. References</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-files">Loading files</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">Inference</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Xueqing Gao
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>